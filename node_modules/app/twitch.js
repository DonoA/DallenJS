var fs = require('fs');
var mysql = require('mysql');
var irc = require("irc");

var streams = [];

var dbconnection = mysql.createConnection(GLOBAL.ConnStr);

dbconnection.connect(function(err) {
  if (err){
    console.error('error connecting: ' + err.stack);
    return;
  }

  console.log('connected as id ' + dbconnection.threadId);
});

for(var key in GLOBAL.Channels){
    (function(k){
        streams.push("#" + k);
        dbconnection.query("SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = '"+GLOBAL.ConnStr.database+"' AND  TABLE_NAME = '"+k+"'", function(err, rows) {
            if(!err&&rows.length==0){
                dbconnection.query("CREATE TABLE "+k+" (chatID int AUTO_INCREMENT, User varchar(30), Chat TEXT, PRIMARY KEY (chatID)) CHARSET=utf8", function(err, rows) {console.log("Created Table for "+k)});
            }
        });
    })(GLOBAL.Channels[key]);
}

fs.readFile('config.json', 'utf8', function (err, data) {
  if(err){
    console.log(err);
  }
  var bot = new irc.Client("irc.twitch.tv", "dallen1393", {
      channels: streams,
      port: 6667,
      password: JSON.parse(data).secrets.twitchKey

  });
  console.log("twitch bot connected");
  bot.addListener("message", function(from, to, text, message) {
      var q = "Insert into "+to.replace("#","")+" (User, Chat) Values ('"+from.replace(new RegExp("'", 'g'), '')+
              "', '"+text.replace(new RegExp("'", 'g'), '')+"')";
      dbconnection.query(q, function(err, rows) {
          if(err){
            //  console.log(q);
            //  console.error('twitch sql error: ' + err.message);
          }
      });
  });
});
